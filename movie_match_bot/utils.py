import asyncio
import logging
import google.generativeai as genai
from config import (
    GEMINI_API_KEY,
    GEMINI_MODEL,
    GEMINI_TEMPERATURE,
    GEMINI_MAX_TOKENS
)

logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Gemini
if GEMINI_API_KEY:
    try:
        genai.configure(api_key=GEMINI_API_KEY)
        logger.info("Gemini API —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Gemini: {str(e)}")
else:
    logger.warning("GEMINI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–µ–∂–∏–º")


async def generate_movie_recommendations(user1_answers, user2_answers):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Ñ–∏–ª—å–º–æ–≤ —á–µ—Ä–µ–∑ Gemini API"""

    prompt = create_prompt(user1_answers, user2_answers)

    if not GEMINI_API_KEY:
        logger.warning("Gemini API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")
        return get_fallback_recommendations(user1_answers, user2_answers)

    try:
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–¥–µ–ª—å Gemini
        generation_config = {
            "temperature": GEMINI_TEMPERATURE,
            "top_p": 0.95,
            "top_k": 40,
            "max_output_tokens": GEMINI_MAX_TOKENS,
        }

        safety_settings = [
            {
                "category": "HARM_CATEGORY_HARASSMENT",
                "threshold": "BLOCK_MEDIUM_AND_ABOVE"
            },
            {
                "category": "HARM_CATEGORY_HATE_SPEECH",
                "threshold": "BLOCK_MEDIUM_AND_ABOVE"
            },
            {
                "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                "threshold": "BLOCK_MEDIUM_AND_ABOVE"
            },
            {
                "category": "HARM_CATEGORY_DANGEROUS_CONTENT",
                "threshold": "BLOCK_MEDIUM_AND_ABOVE"
            },
        ]

        model = genai.GenerativeModel(
            model_name=GEMINI_MODEL,
            generation_config=generation_config,
            safety_settings=safety_settings
        )

        logger.info("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Gemini API...")

        # –í—ã–ø–æ–ª–Ω—è–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
        response = await asyncio.to_thread(
            model.generate_content,
            prompt
        )

        if response and response.text:
            logger.info("–£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Ç Gemini")
            return response.text
        else:
            logger.error(f"–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini: {response}")
            return get_fallback_recommendations(user1_answers, user2_answers)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Gemini API: {str(e)}")
        return get_fallback_recommendations(user1_answers, user2_answers)


def create_prompt(user1_answers, user2_answers):
    """–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è Gemini –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç—ã
    def format_answer(answer, default="–Ω–µ —É–∫–∞–∑–∞–Ω–æ"):
        if answer and answer.strip() and answer.strip().lower() != "–Ω–µ —É–∫–∞–∑–∞–Ω–æ":
            return answer.strip()
        return default

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    user1_genre = format_answer(user1_answers.get('genre'))
    user2_genre = format_answer(user2_answers.get('genre'))
    user1_movies = format_answer(user1_answers.get('favorite_movies'))
    user2_movies = format_answer(user2_answers.get('favorite_movies'))
    user1_mood = format_answer(user1_answers.get('mood'))
    user2_mood = format_answer(user2_answers.get('mood'))
    user1_duration = format_answer(user1_answers.get('duration'))
    user2_duration = format_answer(user2_answers.get('duration'))
    user1_year = format_answer(user1_answers.get('year'))
    user2_year = format_answer(user2_answers.get('year'))
    user1_additional = format_answer(user1_answers.get('additional'), '–Ω–µ—Ç')
    user2_additional = format_answer(user2_answers.get('additional'), '–Ω–µ—Ç')

    prompt = f"""
–¢–´: –≠–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∏–Ω–æ —Å 20-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º, –∫–∏–Ω–æ–∫—Ä–∏—Ç–∏–∫ –∏ –ø—Å–∏—Ö–æ–ª–æ–≥. –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ø–∞—Ä–∞–º –∏ –¥—Ä—É–∑—å—è–º –Ω–∞—Ö–æ–¥–∏—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å–º—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.

–ó–ê–î–ê–ß–ê: –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–µ–¥–ª–æ–∂–∏ 5-7 —Ñ–∏–ª—å–º–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–Ω—Ä–∞–≤—è—Ç—Å—è –û–ë–û–ò–ú –∏ —Å–æ–∑–¥–∞–¥—É—Ç –æ—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.

–ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. –ù–∞–π–¥–∏ –æ–±—â–∏–µ —Ç–µ–º—ã, –∂–∞–Ω—Ä—ã –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
3. –ü—Ä–µ–¥–ª–æ–∂–∏ 5-7 —Ñ–∏–ª—å–º–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥–æ–π–¥—É—Ç –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
4. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∏–ª—å–º–∞ –¥–∞–π:
   - üé¨ –ù–∞–∑–≤–∞–Ω–∏–µ (—Ä—É—Å—Å–∫–æ–µ –∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ)
   - üìÖ –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞
   - üé≠ –ñ–∞–Ω—Ä—ã
   - ‚≠ê IMDb/Kinopoisk —Ä–µ–π—Ç–∏–Ω–≥ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
   - üìù –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
   - ‚ù§Ô∏è –ü–æ—á–µ–º—É –ø–æ–¥—Ö–æ–¥–∏—Ç –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–π –ø–∞—Ä–µ
5. –†–∞–∑–¥–µ–ª–∏ —Ñ–∏–ª—å–º—ã –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ò–¥–µ–∞–ª—å–Ω—ã–π –∫–æ–º–ø—Ä–æ–º–∏—Å—Å", "–î–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è", "–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç–∏—è")
6. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
7. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
8. –í –∫–æ–Ω—Ü–µ –¥–∞–π –æ–±—â–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ –≤—ã–±–æ—Ä—É

–î–ê–ù–ù–´–ï –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–•:

üë§ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ 1:
üé≠ –õ—é–±–∏–º—ã–µ –∂–∞–Ω—Ä—ã: {user1_genre}
üéû –õ—é–±–∏–º—ã–µ —Ñ–∏–ª—å–º—ã: {user1_movies}
üòä –¢–µ–∫—É—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {user1_mood}
‚è±Ô∏è –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {user1_duration}
üìÖ –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–µ –≥–æ–¥—ã –≤—ã–ø—É—Å–∫–∞: {user1_year}
üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: {user1_additional}

üë§ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ 2:
üé≠ –õ—é–±–∏–º—ã–µ –∂–∞–Ω—Ä—ã: {user2_genre}
üéû –õ—é–±–∏–º—ã–µ —Ñ–∏–ª—å–º—ã: {user2_movies}
üòä –¢–µ–∫—É—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {user2_mood}
‚è±Ô∏è –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {user2_duration}
üìÖ –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–µ –≥–æ–¥—ã –≤—ã–ø—É—Å–∫–∞: {user2_year}
üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: {user2_additional}

–ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –ï—Å–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ —É–∫–∞–∑–∞–Ω—ã ("–Ω–µ —É–∫–∞–∑–∞–Ω–æ"), –∏—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ–π —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –æ–ø—ã—Ç, —á—Ç–æ–±—ã –ø–æ–¥–æ–±—Ä–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ, –Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã.

–ù–∞—á–Ω–∏ —Å–≤–æ–π –æ—Ç–≤–µ—Ç —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞: "üé¨ –í–ê–®–ê –ü–ï–†–°–û–ù–ê–õ–¨–ù–ê–Ø –ü–û–î–ë–û–†–ö–ê –§–ò–õ–¨–ú–û–í üçø"
–ü—Ä–æ–¥–æ–ª–∂–∏: 
1. <—Ñ–∏–ª—å–º>
2. <—Ñ–∏–ª—å–º>
–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ

–ò –í–°–ï –ë–û–õ–¨–®–ï –ù–ò–ß–ï–ì–û –ù–ï –ù–ê–î–û
"""

    return prompt


def get_fallback_recommendations(user1_answers, user2_answers):
    """–†–µ–∑–µ—Ä–≤–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ API"""

    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
    def extract_keywords(answer):
        if not answer:
            return []
        keywords = []
        text = answer.lower()

        # –ñ–∞–Ω—Ä—ã
        genres = ["–∫–æ–º–µ–¥–∏—è", "–¥—Ä–∞–º–∞", "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞", "–±–æ–µ–≤–∏–∫", "—Ç—Ä–∏–ª–ª–µ—Ä",
                  "–º–µ–ª–æ–¥—Ä–∞–º–∞", "–¥–µ—Ç–µ–∫—Ç–∏–≤", "—É–∂–∞—Å—ã", "—Ñ—ç–Ω—Ç–µ–∑–∏", "–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è",
                  "–∞–Ω–∏–º–µ", "–º—É–ª—å—Ç—Ñ–∏–ª—å–º", "–±–∏–æ–≥—Ä–∞—Ñ–∏—è", "–∏—Å—Ç–æ—Ä–∏—è", "–¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π"]

        for genre in genres:
            if genre in text:
                keywords.append(genre)

        # –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
        moods = ["–≤–µ—Å–µ–ª–æ–µ", "—Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ", "–≥—Ä—É—Å—Ç–Ω–æ–µ", "–Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ–µ",
                 "—Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–æ–µ", "–≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–µ", "—Å—Ç—Ä–∞—à–Ω–æ–µ", "–∑–∞–≥–∞–¥–æ—á–Ω–æ–µ"]

        for mood in moods:
            if mood in text:
                keywords.append(mood)

        return keywords if keywords else ["—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π", "–ø–æ–ø—É–ª—è—Ä–Ω—ã–π"]

    user1_keywords = extract_keywords(user1_answers.get('genre', '') + ' ' + user1_answers.get('mood', ''))
    user2_keywords = extract_keywords(user2_answers.get('genre', '') + ' ' + user2_answers.get('mood', ''))

    # –ù–∞—Ö–æ–¥–∏–º –æ–±—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
    common_keywords = set(user1_keywords) & set(user2_keywords)
    if not common_keywords:
        common_keywords = {"–∫–æ–º–µ–¥–∏—è", "–¥—Ä–∞–º–∞", "–ø–æ–ø—É–ª—è—Ä–Ω—ã–π"}

    # –ë–∞–∑–∞ —Ñ–∏–ª—å–º–æ–≤ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
    movie_database = {
        "–∫–æ–º–µ–¥–∏—è": [
            {
                "title": "üé¨ 1+1 / Intouchables",
                "year": "2011",
                "genre": "–∫–æ–º–µ–¥–∏—è, –¥—Ä–∞–º–∞, –±–∏–æ–≥—Ä–∞—Ñ–∏—è",
                "rating": "‚≠ê 8.5/10",
                "description": "–ü–æ—Å—Ç–∏–≥—à–∏–π –ø–∞—Ä–∞–ª–∏—á –∞—Ä–∏—Å—Ç–æ–∫—Ä–∞—Ç –Ω–∞–Ω–∏–º–∞–µ—Ç –≤ —Å–∏–¥–µ–ª–∫–∏ –±—ã–≤—à–µ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ. –ò—Å–∫—Ä–µ–Ω–Ω—è—è –¥—Ä—É–∂–±–∞ –∏ —é–º–æ—Ä, –º–µ–Ω—è—é—â–∏–µ –∂–∏–∑–Ω–∏ –æ–±–æ–∏—Ö.",
                "why": "–ò–¥–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —é–º–æ—Ä–∞ –∏ –≥–ª—É–±–æ–∫–∏—Ö —ç–º–æ—Ü–∏–π. –ü–æ–¥–Ω–∏–º–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –Ω–æ —Ç–∞–∫–∂–µ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–¥—É–º–∞—Ç—å—Å—è."
            },
            {
                "title": "üé¨ –î–∂–µ–Ω—Ç–ª—å–º–µ–Ω—ã / The Gentlemen",
                "year": "2019",
                "genre": "–∫–æ–º–µ–¥–∏—è, –±–æ–µ–≤–∏–∫, –∫—Ä–∏–º–∏–Ω–∞–ª",
                "rating": "‚≠ê 7.8/10",
                "description": "–ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–π –Ω–∞—Ä–∫–æ–±–∞—Ä–æ–Ω –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–æ–¥–∞—Ç—å —Å–≤–æ—é –∏–º–ø–µ—Ä–∏—é –ª–æ–Ω–¥–æ–Ω—Å–∫–æ–π –ø—Ä–µ—Å—Ç—É–ø–Ω–æ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–µ.",
                "why": "–°—Ç–∏–ª—å–Ω—ã–π, –æ—Å—Ç—Ä–æ—É–º–Ω—ã–π –∏ –¥–∏–Ω–∞–º–∏—á–Ω—ã–π —Ñ–∏–ª—å–º —Å –±–ª–µ—Å—Ç—è—â–∏–º –∞–∫—Ç–µ—Ä—Å–∫–∏–º —Å–æ—Å—Ç–∞–≤–æ–º."
            }
        ],
        "–¥—Ä–∞–º–∞": [
            {
                "title": "üé¨ –ü–æ–±–µ–≥ –∏–∑ –®–æ—É—à–µ–Ω–∫–∞ / The Shawshank Redemption",
                "year": "1994",
                "genre": "–¥—Ä–∞–º–∞",
                "rating": "‚≠ê 9.3/10",
                "description": "–ù–µ–≤–∏–Ω–Ω–æ –æ—Å—É–∂–¥–µ–Ω–Ω—ã–π –±–∞–Ω–∫–∏—Ä –ø—Ä–æ–≤–æ–¥–∏—Ç –≥–æ–¥—ã –≤ —Ç—é—Ä—å–º–µ, –Ω–µ —Ç–µ—Ä—è—è –Ω–∞–¥–µ–∂–¥—ã –Ω–∞ —Å–≤–æ–±–æ–¥—É.",
                "why": "–û–¥–∏–Ω –∏–∑ –ª—É—á—à–∏—Ö —Ñ–∏–ª—å–º–æ–≤ –≤—Å–µ—Ö –≤—Ä–µ–º–µ–Ω. –ò—Å—Ç–æ—Ä–∏—è –æ –Ω–∞–¥–µ–∂–¥–µ, –¥—Ä—É–∂–±–µ –∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º –¥—É—Ö–µ."
            },
            {
                "title": "üé¨ –§–æ—Ä—Ä–µ—Å—Ç –ì–∞–º–ø / Forrest Gump",
                "year": "1994",
                "genre": "–¥—Ä–∞–º–∞, –∫–æ–º–µ–¥–∏—è, –º–µ–ª–æ–¥—Ä–∞–º–∞",
                "rating": "‚≠ê 8.8/10",
                "description": "–ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä–µ–Ω—å —Å –¥–æ–±—Ä—ã–º —Å–µ—Ä–¥—Ü–µ–º —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–≤–æ–ª—å–Ω—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –∫–ª—é—á–µ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏.",
                "why": "–¢—Ä–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Å–æ—á–µ—Ç–∞–µ—Ç —é–º–æ—Ä, –¥—Ä–∞–º—É –∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è."
            }
        ],
        "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞": [
            {
                "title": "üé¨ –ù–∞—á–∞–ª–æ / Inception",
                "year": "2010",
                "genre": "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞, –±–æ–µ–≤–∏–∫, —Ç—Ä–∏–ª–ª–µ—Ä",
                "rating": "‚≠ê 8.8/10",
                "description": "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–æ—Ä, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∫—Ä–∞–∂–µ –∏–¥–µ–π –∏–∑ –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è, –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–¥–∞–Ω–∏–µ –≤–Ω–µ–¥—Ä–∏—Ç—å –∏–¥–µ—é.",
                "why": "–£–º–Ω—ã–π –∏ –≤–∏–∑—É–∞–ª—å–Ω–æ –≤–ø–µ—á–∞—Ç–ª—è—é—â–∏–π —Ñ–∏–ª—å–º, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –¥—É–º–∞—Ç—å."
            },
            {
                "title": "üé¨ –ò–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä / Interstellar",
                "year": "2014",
                "genre": "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞, –¥—Ä–∞–º–∞, –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è",
                "rating": "‚≠ê 8.6/10",
                "description": "–ì—Ä—É–ø–ø–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π –ø—É—Ç–µ—à–µ—Å—Ç–≤—É–µ—Ç —á–µ—Ä–µ–∑ —á–µ—Ä–≤–æ—Ç–æ—á–∏–Ω—É –≤ –ø–æ–∏—Å–∫–∞—Ö –Ω–æ–≤–æ–≥–æ –¥–æ–º–∞ –¥–ª—è —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞.",
                "why": "–≠–ø–∏—á–Ω–æ–µ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ —Å –≥–ª—É–±–æ–∫–∏–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –ø–æ—Å—ã–ª–æ–º."
            }
        ],
        "–ø–æ–ø—É–ª—è—Ä–Ω—ã–π": [
            {
                "title": "üé¨ –ö–æ—Ä–æ–ª—å –õ–µ–≤ / The Lion King",
                "year": "1994",
                "genre": "–º—É–ª—å—Ç—Ñ–∏–ª—å–º, –¥—Ä–∞–º–∞, –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è",
                "rating": "‚≠ê 8.5/10",
                "description": "–ú–æ–ª–æ–¥–æ–π –ª–µ–≤ –°–∏–º–±–∞ –ø—Ä–µ–¥–∞–µ—Ç —Å–≤–æ–µ –∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–æ –∏–∑–≥–Ω–∞–Ω–Ω—ã–º —Ç–∏—Ä–∞–Ω–æ–º, —Ç–æ–ª—å–∫–æ —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –∏ –æ—Ç–≤–æ–µ–≤–∞—Ç—å –µ–≥–æ.",
                "why": "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è, –Ω–µ–∑–∞–±—ã–≤–∞–µ–º–∞—è –º—É–∑—ã–∫–∞ –∏ –≤–µ—á–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤–∑—Ä–æ—Å–ª–µ–Ω–∏—è."
            },
            {
                "title": "üé¨ –¢–∏—Ç–∞–Ω–∏–∫ / Titanic",
                "year": "1997",
                "genre": "–¥—Ä–∞–º–∞, –º–µ–ª–æ–¥—Ä–∞–º–∞",
                "rating": "‚≠ê 7.9/10",
                "description": "–°–µ–º–Ω–∞–¥—Ü–∞—Ç–∏–ª–µ—Ç–Ω—è—è –∞—Ä–∏—Å—Ç–æ–∫—Ä–∞—Ç–∫–∞ –≤–ª—é–±–ª—è–µ—Ç—Å—è –≤ –¥–æ–±—Ä–æ–≥–æ, –Ω–æ –±–µ–¥–Ω–æ–≥–æ —Ö—É–¥–æ–∂–Ω–∏–∫–∞ –Ω–∞ –±–æ—Ä—Ç—É —Ä–æ—Å–∫–æ—à–Ω–æ–≥–æ –ª–∞–π–Ω–µ—Ä–∞.",
                "why": "–≠–ø–∏—á–µ—Å–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è –ª—é–±–≤–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∫–æ—Ä–∏–ª–∞ –≤–µ—Å—å –º–∏—Ä."
            }
        ],
        "—Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ": [
            {
                "title": "üé¨ –î–Ω–µ–≤–Ω–∏–∫ –ø–∞–º—è—Ç–∏ / The Notebook",
                "year": "2004",
                "genre": "–¥—Ä–∞–º–∞, –º–µ–ª–æ–¥—Ä–∞–º–∞",
                "rating": "‚≠ê 7.8/10",
                "description": "–ü–æ–∂–∏–ª–æ–π –º—É–∂—á–∏–Ω–∞ —á–∏—Ç–∞–µ—Ç —Å–≤–æ–µ–π –∂–µ–Ω–µ –∏—Å—Ç–æ—Ä–∏—é –ª—é–±–≤–∏ –¥–≤—É—Ö –º–æ–ª–æ–¥—ã—Ö –ª—é–¥–µ–π –≤ 1940-—Ö –≥–æ–¥–∞—Ö.",
                "why": "–û–¥–Ω–∞ –∏–∑ —Å–∞–º—ã—Ö —Ç—Ä–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –∏ –∫—Ä–∞—Å–∏–≤—ã—Ö –∏—Å—Ç–æ—Ä–∏–π –ª—é–±–≤–∏ –≤ –∫–∏–Ω–æ."
            }
        ]
    }

    # –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–ª—å–º—ã
    selected_movies = []
    categories_used = set()

    for keyword in common_keywords:
        if keyword in movie_database and keyword not in categories_used:
            selected_movies.extend(movie_database[keyword])
            categories_used.add(keyword)
            if len(selected_movies) >= 6:
                break

    # –ï—Å–ª–∏ –º–∞–ª–æ —Ñ–∏–ª—å–º–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º –∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö
    if len(selected_movies) < 4:
        for movie in movie_database["–ø–æ–ø—É–ª—è—Ä–Ω—ã–π"]:
            if movie not in selected_movies:
                selected_movies.append(movie)

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    recommendations = "üé¨ –í–ê–®–ê –ü–ï–†–°–û–ù–ê–õ–¨–ù–ê–Ø –ü–û–î–ë–û–†–ö–ê –§–ò–õ–¨–ú–û–í üçø\n\n"
    recommendations += f"üìä –ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π: {', '.join(common_keywords)}\n\n"

    for i, movie in enumerate(selected_movies[:6], 1):
        recommendations += f"{movie['title']} ({movie['year']})\n"
        recommendations += f"{movie['genre']} | {movie['rating']}\n"
        recommendations += f"üìù {movie['description']}\n"
        recommendations += f"‚ù§Ô∏è {movie['why']}\n\n"

    recommendations += "üí° –°–æ–≤–µ—Ç—ã –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:\n"
    recommendations += "‚Ä¢ –û–±—Å—É–¥–∏—Ç–µ —Ñ–∏–ª—å–º—ã –ø–µ—Ä–µ–¥ –≤—ã–±–æ—Ä–æ–º\n"
    recommendations += "‚Ä¢ –ß–µ—Ä–µ–¥—É–π—Ç–µ –∂–∞–Ω—Ä—ã –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è\n"
    recommendations += "‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ –≤–º–µ—Å—Ç–µ!\n\n"
    recommendations += "üçø –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞!"

    return recommendations